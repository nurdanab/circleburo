import{r as e,j as s}from"./vendor-react-DGsprnG_.js";import{s as t}from"./supabaseClient-CtA22CKB.js";import{L as a,S as l,R as r,D as n,b as i,c,U as d,P as o,d as x,e as m,f as h,g,h as u,C as p}from"./lucide-icons-BzS6JU5C.js";import{m as w,A as j}from"./framer-motion-CNyOhlkC.js";import"./analytics-jR0q-LqR.js";import"./supabase-D6DFX1W9.js";import"./vendor-CCnSY37f.js";const b={PENDING:"pending",CONFIRMED:"confirmed",CANCELLED:"cancelled"};const N={[b.PENDING]:"Pending",[b.CONFIRMED]:"Confirmed",[b.CANCELLED]:"Cancelled"};const f={[b.PENDING]:{bg:"bg-yellow-100",text:"text-yellow-800",border:"border-yellow-200",dot:"bg-yellow-400"},[b.CONFIRMED]:{bg:"bg-green-100",text:"text-green-800",border:"border-green-200",dot:"bg-green-400"},[b.CANCELLED]:{bg:"bg-red-100",text:"text-red-800",border:"border-red-200",dot:"bg-red-400"}};const y=()=>{const[y,v]=e.useState([]);const[D,C]=e.useState(!0);const[E,L]=e.useState("");const[S,_]=e.useState("");const[k,I]=e.useState("all");const[R,A]=e.useState("all");const[O,$]=e.useState(null);const[T,P]=e.useState(null);const[F,M]=e.useState("created_at");const[H,U]=e.useState("desc");const[G,q]=e.useState({});const J=e=>{if(F===e)U("asc"===H?"desc":"asc");else{M(e);U("asc")}};const V=async()=>{C(!0);try{const{data:e,error:s}=await t.from("leads").select("*").order("created_at",{ascending:!1});if(s)throw s;v(e||[]);const a={};e.forEach(e=>{a[e.id]=e.notes||""});q(a)}catch(e){void 0;L("Ошибка загрузки данных")}finally{C(!1)}};const Q=async(e,s)=>{void 0;$(e);try{const{error:a}=await t.from("leads").update({status:s,updated_at:new Date}).eq("id",e);if(a)throw a;void 0;v(t=>t.map(t=>t.id===e?{...t,status:s}:t));await B(e,s)}catch(a){void 0;L("Ошибка обновления статуса")}finally{$(null)}};const X=async e=>{P(e);try{const s=G[e];const{error:a}=await t.from("leads").update({notes:s,updated_at:new Date}).eq("id",e);if(a)throw a;v(t=>t.map(t=>t.id===e?{...t,notes:s}:t));void 0}catch(s){void 0;L("Ошибка сохранения заметок")}finally{P(null)}};const Y=async e=>{$(e);try{const{error:s}=await t.from("leads").delete().eq("id",e);if(s)throw s;void 0;v(s=>s.filter(s=>s.id!==e));await z(e)}catch(s){void 0;L("Ошибка удаления заявки")}finally{$(null)}};const z=async e=>{const s="8193267768:AAFgL65AXJAwjv5iHCNncDV-QNt6mjReqYo";const t="-4968632931";try{const a=`\n🗑️ Заявка удалена!\n\nID: ${e}\nВремя удаления: ${(new Date).toLocaleString("ru-RU")}\n      `.trim();await fetch(`https://api.telegram.org/bot${s}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:t,text:a})})}catch(a){void 0}};const B=async(e,s)=>{const t="8193267768:AAFgL65AXJAwjv5iHCNncDV-QNt6mjReqYo";const a="-4968632931";try{const l=y.find(s=>s.id===e);if(!l)return;const r=`\n${{[b.PENDING]:"⏳",[b.CONFIRMED]:"✅",[b.CANCELLED]:"❌"}[s]} new!\n\nИмя: ${l.name}\nТелефон: +${l.phone}\nДата: ${new Date(l.meeting_date).toLocaleDateString("ru-RU")}\nВремя: ${l.meeting_time}\nСтатус: ${N[s]}\n      `.trim();await fetch(`https://api.telegram.org/bot${t}/sendMessage`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chat_id:a,text:r})})}catch(l){void 0}};const K=y.filter(e=>{const s=e.name.toLowerCase().includes(S.toLowerCase())||e.phone.includes(S);const t="all"===k||e.status===k;const a="all"===R||(()=>{const s=new Date(e.meeting_date);const t=new Date;const a=new Date(t);a.setDate(t.getDate()+1);const l=new Date(t);l.setDate(t.getDate()+7);switch(R){case"today":return s.toDateString()===t.toDateString();case"tomorrow":return s.toDateString()===a.toDateString();case"week":return s>=t&&s<=l;case"past":return s<t;default:return!0}})();return s&&t&&a}).sort((e,s)=>{let t,a;switch(F){case"name":t=e.name.toLowerCase();a=s.name.toLowerCase();break;case"phone":t=e.phone;a=s.phone;break;case"meeting_date":t=new Date(e.meeting_date+"T"+e.meeting_time);a=new Date(s.meeting_date+"T"+s.meeting_time);break;case"status":t=e.status;a=s.status;break;default:t=new Date(e.created_at);a=new Date(s.created_at)}return t<a?"asc"===H?-1:1:t>a?"asc"===H?1:-1:0});const W=()=>{const e=K.map(e=>({ID:e.id,"Имя":e.name,"Телефон":`+${e.phone}`,"Дата встречи":e.meeting_date,"Время встречи":e.meeting_time,"Статус":N[e.status],"Создано":new Date(e.created_at).toLocaleString("ru-RU"),"Заметки":e.notes||""}));const s=[Object.keys(e[0]).join(","),...e.map(e=>Object.values(e).map(e=>`"${String(e).replace(/"/g,'""')}"`).join(","))].join("\n");const t=new Blob([s],{type:"text/csv"});const a=window.URL.createObjectURL(t);const l=document.createElement("a");l.href=a;l.download=`leads_${(new Date).toISOString().split("T")[0]}.csv`;l.click();window.URL.revokeObjectURL(a)};const Z=({field:e,children:t})=>s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 transition-colors",onClick:()=>J(e),children:s.jsxs("div",{className:"flex items-center gap-1",children:[t,F===e&&("asc"===H?s.jsx(u,{className:"w-4 h-4"}):s.jsx(p,{className:"w-4 h-4"}))]})});e.useEffect(()=>{V()},[]);e.useEffect(()=>{const e=setInterval(()=>{V()},3e4);return()=>clearInterval(e)},[]);return D?s.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:s.jsxs("div",{className:"flex flex-col items-center gap-4",children:[s.jsx(a,{className:"w-8 h-8 animate-spin text-blue-600"}),s.jsx("p",{className:"text-gray-600",children:"Загрузка данных..."})]})}):s.jsx("div",{className:"min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8 pt-10",children:s.jsxs("div",{className:"max-w-7xl mx-auto",children:[s.jsxs("div",{className:"mb-8",children:[s.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Админ панель - Управление лидами"}),s.jsxs("p",{className:"text-gray-600",children:["Всего заявок: ",y.length," | Отфильтровано: ",K.length]})]}),s.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:s.jsxs("div",{className:"flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between",children:[s.jsxs("div",{className:"relative flex-1 max-w-md",children:[s.jsx(l,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),s.jsx("input",{type:"text",placeholder:"Поиск по имени или телефону...",value:S,onChange:e=>_(e.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),s.jsxs("div",{className:"flex gap-3",children:[s.jsxs("select",{value:k,onChange:e=>I(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[s.jsx("option",{value:"all",children:"Все статусы"}),s.jsx("option",{value:b.PENDING,children:"В ожидании"}),s.jsx("option",{value:b.CONFIRMED,children:"Подтвержденные"}),s.jsx("option",{value:b.CANCELLED,children:"Отмененные"})]}),s.jsxs("select",{value:R,onChange:e=>A(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[s.jsx("option",{value:"all",children:"Все даты"}),s.jsx("option",{value:"today",children:"Сегодня"}),s.jsx("option",{value:"tomorrow",children:"Завтра"}),s.jsx("option",{value:"week",children:"На неделе"}),s.jsx("option",{value:"past",children:"Прошедшие"})]})]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsxs(w.button,{onClick:V,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",whileHover:{scale:1.02},whileTap:{scale:.98},children:[s.jsx(r,{className:"w-4 h-4"}),"Обновить"]}),s.jsxs(w.button,{onClick:W,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",whileHover:{scale:1.02},whileTap:{scale:.98},children:[s.jsx(n,{className:"w-4 h-4"}),"Экспорт CSV"]})]})]})}),s.jsx(j,{children:E&&s.jsxs(w.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6 flex items-center gap-3",children:[s.jsx(i,{className:"w-5 h-5 text-red-500 flex-shrink-0"}),s.jsx("span",{className:"text-red-700",children:E}),s.jsx("button",{onClick:()=>L(""),className:"ml-auto text-red-500 hover:text-red-700",children:s.jsx(c,{className:"w-4 h-4"})})]})}),s.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:0===K.length?s.jsxs("div",{className:"p-8 text-center",children:[s.jsx(d,{className:"w-12 h-12 text-gray-400 mx-auto mb-4"}),s.jsx("p",{className:"text-gray-600 text-lg mb-2",children:"Лидов не найдено"}),s.jsx("p",{className:"text-gray-400",children:"Попробуйте изменить фильтры поиска"})]}):s.jsx("div",{className:"overflow-x-auto",children:s.jsxs("table",{className:"w-full",children:[s.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:s.jsxs("tr",{children:[s.jsx(Z,{field:"name",children:"Клиент"}),s.jsx(Z,{field:"phone",children:"Контакты"}),s.jsx(Z,{field:"meeting_date",children:"Встреча"}),s.jsx(Z,{field:"status",children:"Статус"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-80",children:"Заметки"}),s.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Действия"})]})}),s.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:K.map(e=>s.jsxs(w.tr,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"hover:bg-gray-50 transition-colors",children:[s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{className:"flex items-center",children:[s.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:s.jsx(d,{className:"w-4 h-4 text-blue-600"})}),s.jsxs("div",{className:"ml-3",children:[s.jsx("div",{className:"text-sm font-medium text-gray-900",children:e.name}),s.jsxs("div",{className:"text-sm text-gray-500",children:["ID: ",e.id]})]})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{className:"flex items-center",children:[s.jsx(o,{className:"w-4 h-4 text-gray-400 mr-2"}),s.jsxs("span",{className:"text-sm text-gray-900",children:["+",e.phone]})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{className:"space-y-1",children:[s.jsxs("div",{className:"flex items-center",children:[s.jsx(x,{className:"w-4 h-4 text-gray-400 mr-2"}),s.jsx("span",{className:"text-sm text-gray-900",children:new Date(e.meeting_date).toLocaleDateString("ru-RU",{day:"numeric",month:"long",year:"numeric"})})]}),s.jsxs("div",{className:"flex items-center",children:[s.jsx(m,{className:"w-4 h-4 text-gray-400 mr-2"}),s.jsx("span",{className:"text-sm text-gray-900",children:e.meeting_time})]})]})}),s.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:s.jsxs("div",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${f[e.status].bg} ${f[e.status].text} ${f[e.status].border} border`,children:[s.jsx("div",{className:`w-1.5 h-1.5 ${f[e.status].dot} rounded-full mr-1.5`}),N[e.status]]})}),s.jsx("td",{className:"px-6 py-4",children:s.jsx("textarea",{className:"w-full h-20 text-sm border border-gray-300 rounded-md p-2 resize-y",value:G[e.id],onChange:s=>q({...G,[e.id]:s.target.value}),placeholder:"Заметки..."})}),s.jsx("td",{className:"px-6 py-4",children:s.jsxs("div",{className:"flex gap-2 flex-col items-start min-w-[200px]",children:[s.jsxs(w.button,{onClick:()=>X(e.id),disabled:T===e.id,className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white text-sm rounded-lg hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 w-full justify-center shadow-sm",whileHover:{scale:1.02},whileTap:{scale:.98},children:[T===e.id?s.jsx(a,{className:"w-4 h-4 animate-spin"}):s.jsx(h,{className:"w-4 h-4"}),"Сохранить заметки"]}),e.status!==b.CONFIRMED&&s.jsxs(w.button,{onClick:()=>Q(e.id,b.CONFIRMED),disabled:O===e.id,className:"flex items-center gap-2 px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 w-full justify-center shadow-sm",whileHover:{scale:1.02},whileTap:{scale:.98},children:[O===e.id?s.jsx(a,{className:"w-4 h-4 animate-spin"}):s.jsx(g,{className:"w-4 h-4"}),"Подтвердить"]}),e.status!==b.CANCELLED&&s.jsxs(w.button,{onClick:()=>Q(e.id,b.CANCELLED),disabled:O===e.id,className:"flex items-center gap-2 px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 w-full justify-center shadow-sm",whileHover:{scale:1.02},whileTap:{scale:.98},children:[O===e.id?s.jsx(a,{className:"w-4 h-4 animate-spin"}):s.jsx(c,{className:"w-4 h-4"}),"Отменить"]}),e.status===b.CANCELLED&&s.jsxs(w.button,{onClick:()=>Q(e.id,b.PENDING),disabled:O===e.id,className:"flex items-center gap-2 px-4 py-2 bg-yellow-600 text-white text-sm rounded-lg hover:bg-yellow-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 w-full justify-center shadow-sm",whileHover:{scale:1.02},whileTap:{scale:.98},children:[O===e.id?s.jsx(a,{className:"w-4 h-4 animate-spin"}):s.jsx(r,{className:"w-4 h-4"}),"Восстановить"]}),s.jsxs(w.button,{onClick:()=>{window.confirm("Вы уверены, что хотите удалить эту заявку? Это действие нельзя отменить.")&&Y(e.id)},disabled:O===e.id,className:"flex items-center gap-2 px-4 py-2 bg-red-800 text-white text-sm rounded-lg hover:bg-red-900 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 w-full justify-center shadow-sm",whileHover:{scale:1.02},whileTap:{scale:.98},children:[O===e.id?s.jsx(a,{className:"w-4 h-4 animate-spin"}):s.jsx(c,{className:"w-4 h-4"}),"Удалить"]})]})})]},e.id))})]})})}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mt-8",children:[s.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"В ожидании"}),s.jsx("p",{className:"text-2xl font-bold text-yellow-600",children:y.filter(e=>e.status===b.PENDING).length})]}),s.jsx("div",{className:"w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center",children:s.jsx(m,{className:"w-4 h-4 text-yellow-600"})})]})}),s.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Подтверждено"}),s.jsx("p",{className:"text-2xl font-bold text-green-600",children:y.filter(e=>e.status===b.CONFIRMED).length})]}),s.jsx("div",{className:"w-8 h-8 bg-green-100 rounded-full flex items-center justify-center",children:s.jsx(g,{className:"w-4 h-4 text-green-600"})})]})}),s.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Отменено"}),s.jsx("p",{className:"text-2xl font-bold text-red-600",children:y.filter(e=>e.status===b.CANCELLED).length})]}),s.jsx("div",{className:"w-8 h-8 bg-red-100 rounded-full flex items-center justify-center",children:s.jsx(c,{className:"w-4 h-4 text-red-600"})})]})})]})]})})};export{y as default};
